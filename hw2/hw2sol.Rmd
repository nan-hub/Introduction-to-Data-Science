---
title: "Biostat 203B Homework 2"
subtitle: Due Feb 7 @ 11:59PM
author: Nan Liu
uid: 505460070
output:
  html_document:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

Use tidyverse (ggpot2, dplyr) to explore the [MIMIC-III](https://mimic.physionet.org) data introduced in [homework 1](https://ucla-biostat203b-2020winter.github.io/hw/hw1/hw1.html).

**first load tidyverse and lubridate**
```{r}
library("tidyverse")
library("lubridate")
```

## Q1

Demographic information of the patients admitted into hospital is available in `ADMISSION.csv`. See <https://mimic.physionet.org/mimictables/admissions/> for details of each field in this file. Summarize following variables using appropriate graphs:   

  - admission year  
- admission month  
- admission week day  
- admission hour  
- length of hospital stay  
- admission type  
- number of admissions per patient  
- admission location  
- insurance  
- language  
- religion  
- martial status  
- ethnicity  
- death 


**Solution:**
**First import data:**

First, let's display the first 10 lines of `ADMISSIONS.csv`:
```{bash}
head /home/203bdata/mimic-iii/ADMISSIONS.csv 
```

```{r}
admissions<-read_csv("/home/203bdata/mimic-iii/ADMISSIONS.csv")
admissions %>% print(width = Inf)
```



- admission year

```{r}
#not unique data
admissions %>%
  mutate(adm_year = year(ADMITTIME)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = adm_year)) + 
  labs(x = "admission year")
```

-admission month

```{r}
#not unique data
admissions %>%
  mutate(adm_month = month(ADMITTIME, label = TRUE)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = adm_month)) +
  labs(x = "Admission month")
```

-admission week day

```{r}
#not unique data
admissions %>%
  mutate(adm_weekday = wday(ADMITTIME, label = TRUE)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = adm_weekday)) +
  labs(x = "Admission week day")
```

-admission hour

```{r}
#not unique data
admissions %>%
  mutate(adm_hour = hour(ADMITTIME)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = adm_hour)) +
  labs(x = "Admission hour")
```

-admission minute
```{r}
admissions %>%
  mutate(adm_min = minute(ADMITTIME)) %>%
  ggplot() + 
  geom_freqpoly(mapping = aes(x = adm_min)) +
  labs(x = "Admission minute")
```

-length of hospital stay

```{r warning=FALSE}
#not unique data
admissions %>%
  mutate(lenstay = as.numeric(as.duration(DISCHTIME - ADMITTIME) / 86400)) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = lenstay),bins = 100) +
  labs(x = "Length of hospital stay in (days)")
```

- admission type  

```{r}
#not unique data
ggplot(data = admissions) + 
  geom_bar(mapping = aes(x = ADMISSION_TYPE)) + 
  labs(x = "admission type")
```

- number of admissions per patient  

```{r}
admissionsnum <- admissions %>% 
  group_by(SUBJECT_ID) %>% 
  summarise(
    count = n())
ggplot(data = admissionsnum) + 
  geom_bar(mapping = aes(x = count)) + 
  labs(x = "number of admissions per patient")
```

- admission location  

```{r}
#not unique data
ggplot(data = admissions) + 
  geom_bar(mapping = aes(x = ADMISSION_LOCATION))+
  labs(x = "admission location") + 
  theme(axis.text.x = element_text(size  = 8,
                                   angle = 45,
                                   hjust = 1,
                                   vjust = 1))
```

- insurance  

```{r}
#not unique data
ggplot(data = admissions) + 
  geom_bar(mapping = aes(x =INSURANCE)) +
  labs(x = "insurance")
```

- language  

```{r}
#unique data
admissionsUNIQ <- distinct(admissions, SUBJECT_ID, .keep_all = TRUE)
ggplot(data = admissionsUNIQ) + 
  geom_bar(mapping = aes(x =LANGUAGE)) +
  labs(x = "language") + 
  theme(axis.text.x =element_text(size  = 8,
                                  angle = 70,
                                  hjust = 1,
                                  vjust = 1))
```

- religion 

```{r}
#not unique data
ggplot(data = admissions) + 
  geom_bar(mapping = aes(x = RELIGION)) +
  labs(x = "religion") + 
  theme(axis.text.x = element_text(size  = 8,
                                   angle = 45,
                                   hjust = 1,
                                   vjust = 1))
```

- martial status 

```{r}
#not unique data
ggplot(data = admissions) + 
  geom_bar(mapping = aes(x = MARITAL_STATUS)) + 
  labs(x = "martial status") + 
  theme(axis.text.x = element_text(size  = 8,
                                   angle = 45,
                                   hjust = 1,
                                   vjust = 1))
```

- ethnicity  

```{r}
#unique data
ggplot(data = admissionsUNIQ) + 
  geom_bar(mapping = aes(x = ETHNICITY)) +
  labs(x = "ethnicity") + 
  theme(axis.text.x = element_text(size  = 5,
                                   angle = 70,
                                   hjust = 1,
                                   vjust = 1))
```

- death 

```{r}
admissions %>% 
  group_by(SUBJECT_ID) %>%
  arrange(desc(ADMITTIME)) %>%
  distinct(SUBJECT_ID, .keep_all = TRUE) %>%
  mutate(livedeath =ifelse(is.na(DEATHTIME) == FALSE, "death", "live")) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = livedeath)) + 
  labs(x = "death and alive")
```

Note it is possible that one patient (uniquely identified by the `SUBJECT_ID`) is admitted into hospital multiple times. When summarizing some demographic information, it makes sense to summarize based on only unique patients. 

## Q2

Link the data in `ADMISSION.csv` and `PATIENTS.csv` (<https://mimic.physionet.org/mimictables/patients/>) and summarize following variables using appropriate graphs:  

**Solution:**

First let's import `PATIENTS.csv` and comnbine two files:
```{r}
patients <- read_csv("/home/203bdata/mimic-iii/PATIENTS.csv")
comb <- admissions %>%
  left_join(patients, by = "SUBJECT_ID")
```

- gender 
```{r}
distinct(comb, SUBJECT_ID,.keep_all = TRUE) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = GENDER))
```

- age at admission 
```{r}
comb %>%
  filter(!is.na(ADMITTIME), !is.na(DOB)) %>%
  mutate(age = (ADMITTIME - DOB) / 31536000,
         AGE= round (age, 0)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = AGE))
```


## Q3

`ICUSTAYS.csv` (<https://mimic.physionet.org/mimictables/icustays/>) contains data about Intensive Care Units (ICU) stays. Summarize following variables using appropriate graphs:  


**Solution:**

First let's import `ICUSTAYS.csv`:

```{r}
icu <- read_csv("/home/203bdata/mimic-iii/ICUSTAYS.csv")
```

- length of ICU stay

```{r}
icu %>%
  filter(!is.na(OUTTIME), !is.na(INTIME)) %>%
  mutate(day = (OUTTIME - INTIME) / 86400,
         DAY = round(day, 0)) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = DAY))
```

- first ICU unit

```{r}
distinct(icu, SUBJECT_ID,.keep_all = TRUE) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = FIRST_CAREUNIT))
```

- gender  
```{r}
#not unique????
icuinfo <- icu %>%
  left_join(patients, by = "SUBJECT_ID")
icuinfo %>%
  distinct(SUBJECT_ID,.keep_all = TRUE) %>%
  ggplot() + 
  geom_bar(mapping = aes(x = GENDER))
```

- age  
```{r}
icuinfo %>%
  filter(!is.na(DOB), !is.na(INTIME)) %>%
  mutate(icuage = (INTIME - DOB)/525600,
         ICUAGE = round (icuage,0)) %>%
  ggplot() + 
  geom_histogram(mapping = aes(x = ICUAGE), binwidth = 5)
```




## Q4 

`CHARTEVENTS.csv` (<https://mimic.physionet.org/mimictables/chartevents/>) contains all the charted data available for a patient. During their ICU stay, the primary repository of a patientâ€™s information is their electronic chart. The `ITEMID` variable indicates a single measurement type in the database. The `VALUE` variable is the value measured for `ITEMID`. 

`D_ITEMS.csv` (<https://mimic.physionet.org/mimictables/d_items/>) is the dictionary for the `ITEMID` in `CHARTEVENTS.csv`. Find potential values of `ITEMID` that correspond to systolic blood pressure, i.e., `LABEL` contains the string `systolic`. 

Compile a tibble that contains the first ICU stay of unique patients, with the patient's demographic information, the first systolic blood pressure measurement during ICU stay, and whether the patient died within 30 days of hospitcal admission.

**Solution:**
First import two files:

```{r}
chart <- read_csv("/home/203bdata/mimic-iii/CHARTEVENTS.csv")
itemid <- read_csv("/home/203bdata/mimic-iii/D_ITEMS.csv")
```

Then find potential values of `ITEMID` that correspond to systolic blood pressure:
```{r}

```



